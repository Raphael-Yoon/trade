from google import genai
import pandas as pd
import os
from dotenv import load_dotenv

# .env 파일에서 환경 변수 로드
env_path = os.path.join(os.path.dirname(__file__), '.env')
load_dotenv(env_path)

# API 키 설정 (환경 변수에서 읽어옴)
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

def analyze_stock_data(file_path):
    """
    엑셀 데이터를 읽어서 Gemini AI에게 분석을 요청합니다.
    """
    if not os.path.exists(file_path):
        return "파일을 찾을 수 없습니다."

    if not GEMINI_API_KEY:
        return "Gemini API 키가 설정되지 않았습니다. .env 파일에 GEMINI_API_KEY를 입력해주세요."

    try:
        # 엑셀 데이터 로드
        df = pd.read_excel(file_path)
        
        # 데이터 요약 (너무 많으면 API 토큰 제한에 걸릴 수 있으므로 상위 30개 정도만 요약)
        # 주요 지표 위주로 텍스트 변환
        data_summary = df.head(30).to_string(index=False)
        
        # Gemini 설정 (새로운 google-genai SDK 사용)
        client = genai.Client(api_key=GEMINI_API_KEY)
        
        prompt = f"""
        너는 전문 주식 퀀트 투자 분석가이자 시장 전략가야. 
        아래는 최근 수집된 국내 주식 시장의 재무 데이터(상위 30개 종목)야. 여기에는 전년 동기 대비 성장성 지표들이 포함되어 있어.
        
        [데이터]
        {data_summary}
        
        이 데이터를 바탕으로 다음을 분석하여 전문적인 투자 리포트를 작성해줘:
        
        **주의**: 
        - 데이터의 '데이터기준' 컬럼은 해당 종목의 재무 수치가 어떤 DART 보고서 기반인지 나타냅니다. 
        - **성장성 지표 활용**: '매출액증가율(%)', '영업이익증가율(%)', '순이익증가율(%)' 데이터가 있다면 이를 놓치지 말고 분석에 반영하여 기업의 실적 추이를 정확히 진단해줘.
        - **중요: 분기 데이터 해석 방식**: '3분기보고서', '반기보고서' 등은 당해 연도 1월부터의 **누적 실적**입니다. 3분기 매출이 작년 사업보고서 매출보다 적어 보이는 것은 당연하므로, 이를 '실적 악화'로 오해하지 말고 **9개월치 누적임을 감안하여 12개월치로 연환산(Annualizing)**하거나 기간을 명시하여 분석해줘.
        - **DART 공시 규칙 준수**: '2024년 사업보고서'는 '2024년 회계연도(1월~12월)' 전체 실적입니다. 보고서 연도와 실적 연도는 동일하게 취급해줘.
        - **중요**: 수치가 **0이거나 'NaN', 'N/A'인 지표는 분석에서 제외하고 표에도 포함하지 마.** 
        - **가독성 및 테이블 레이아웃**: 큰 숫자는 '조', '억' 단위를 사용하여 **'401.6조'** 또는 **'125.7조'**와 같이 간결하게 포맷팅해줘.

        1. **종합 추천 의견 (Top 5 Picks)**:
           - **중요**: 각 종목의 시작은 반드시 **### 종목명** (3단계 헤더)으로 작성해줘.
           - 각 종목별로 **추천 이유**, **핵심 섹터**, **투자 포인트**를 명확하게 구분해서 작성해줘.
           - 현재 시장 트렌드와 데이터상의 수치를 결합하여 왜 이 종목이 선정되었는지 논리적으로 설명해줘.

        2. **종목별 상세 수치 데이터 분석 (표 형식 필수)**:
           - 선정된 5개 종목 각각에 대해, **데이터가 존재하는 주요 지표들만** 선별하여 **마크다운 표(Table) 형식**으로 정리해줘.
           - 성장성 지표(매출/영업이익/순이익 증가율)가 있다면 반드시 포함하여 전년 대비 실적 추이를 보여줘.
           - 특히 PBR, PER의 경우 업종평균 수치와 비교하여 해당 종목이 저평가 상태인지 분석해줘.

        3. **산업 테마 및 최신 동향 분석**:
           - 현재 시장을 주도하는 테마와 선정된 종목들의 연관성을 분석해줘.

        4. **시장 전망 및 투자 전략**:
           - 향후 대응 전략과 리스크 요인을 전문가의 시각에서 조언해줘.

        **작성 가이드라인:**
        - **친절한 디자인**: 종목명이 크게 보일 수 있도록 `###` 헤더를 절대 잊지 마.
        - **가독성**: 문단과 문단 사이, 섹션과 섹션 사이에는 빈 줄을 2개 이상 넣어 여유 있게 배치해줘.
        - **이모지**: 적절한 이모지를 사용하여 리포트가 딱딱하지 않고 친절하게 느껴지도록 해줘.
        - 답변은 한국어로, 전문적이면서도 친절한 어조로 작성해줘.
        """
        
        # 새로운 SDK 방식으로 호출 (gemini-2.0-flash 사용)
        response = client.models.generate_content(
            model='gemini-2.0-flash',
            contents=prompt
        )
        return response.text

    except Exception as e:
        return f"AI 분석 중 오류가 발생했습니다: {str(e)}"
