import google.generativeai as genai
import pandas as pd
import os
from dotenv import load_dotenv

# .env 파일에서 환경 변수 로드
env_path = os.path.join(os.path.dirname(__file__), '.env')
load_dotenv(env_path)

# API 키 설정 (환경 변수에서 읽어옴)
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")

def analyze_stock_data(file_path):
    """
    엑셀 데이터를 읽어서 Gemini AI에게 분석을 요청합니다.
    """
    if not os.path.exists(file_path):
        return "파일을 찾을 수 없습니다."

    if not GEMINI_API_KEY:
        return "Gemini API 키가 설정되지 않았습니다. .env 파일에 GEMINI_API_KEY를 입력해주세요."

    try:
        # 엑셀 데이터 로드
        df = pd.read_excel(file_path)
        
        # 데이터 요약 (너무 많으면 API 토큰 제한에 걸릴 수 있으므로 상위 30개 정도만 요약)
        # 주요 지표 위주로 텍스트 변환
        data_summary = df.head(30).to_string(index=False)
        
        # Gemini 설정
        genai.configure(api_key=GEMINI_API_KEY)
        # 무료 등급 할당량이 가장 넉넉한 gemini-flash-latest 사용
        model = genai.GenerativeModel('gemini-flash-latest')
        
        prompt = f"""
        너는 전문 주식 퀀트 투자 분석가이자 시장 전략가야. 
        아래는 최근 수집된 국내 주식 시장의 재무 데이터(상위 30개 종목)야. 여기에는 전년 동기 대비 성장성 지표들이 포함되어 있어.
        
        [데이터]
        {data_summary}
        
        이 데이터를 바탕으로 다음을 분석하여 전문적인 투자 리포트를 작성해줘:
        
        **주의**: 
        - 데이터의 '데이터기준' 컬럼은 해당 종목의 재무 수치가 어떤 DART 보고서 기반인지 나타냅니다. 
        - **성장성 지표 활용**: '매출액증가율(%)', '영업이익증가율(%)', '순이익증가율(%)' 데이터가 있다면 이를 놓치지 말고 분석에 반영하여 기업의 실적 추이를 정확히 진단해줘.
        - **중요: 분기 데이터 해석 방식**: '3분기보고서', '반기보고서' 등은 당해 연도 1월부터의 **누적 실적**입니다. 3분기 매출이 작년 사업보고서 매출보다 적어 보이는 것은 당연하므로, 이를 '실적 악화'로 오해하지 말고 **9개월치 누적임을 감안하여 12개월치로 연환산(Annualizing)**하거나 기간을 명시하여 분석해줘.
        - **DART 공시 규칙 준수**: '2024년 사업보고서'는 '2024년 회계연도(1월~12월)' 전체 실적입니다. 보고서 연도와 실적 연도는 동일하게 취급해줘.
        - **중요**: 수치가 **0이거나 'NaN', 'N/A'인 지표는 분석에서 제외하고 표에도 포함하지 마.** 
        - **가독성 및 테이블 레이아웃**: 큰 숫자는 '조', '억' 단위를 사용하여 **'401.6조'** 또는 **'125.7조'**와 같이 간결하게 포맷팅해줘.

        1. **종합 추천 의견 (Top 5 Picks)**:
           - 제공된 **재무 데이터**와 **성장성 지표(YoY)**를 종합적으로 참고하여, 현재 시장의 핵심 테마(예: **반도체, AI, HBM, 밸류업 프로그램 등**)와 산업 트렌드에 부합하는 가장 유망한 종목 5개를 선정해줘.
           - **종목명**과 함께 추천 이유를 요약해줘. (종목코드는 제외)

        2. **종목별 상세 수치 데이터 분석 (표 형식 필수)**:
           - 선정된 5개 종목 각각에 대해, **데이터가 존재하는 주요 지표들만** 선별하여 **마크다운 표(Table) 형식**으로 정리해줘. (수치가 0인 항목은 제외)
           - **성장성 지표(매출/영업이익/순이익 증가율)가 있다면 반드시 포함**하여 전년 대비 실적 추이를 보여줘.
           - **특히 PBR, PER의 경우 업종평균 수치와 비교하여 해당 종목이 저평가 상태인지 분석해줘.** 만약 업종평균 데이터가 있다면 반드시 활용해줘.
           - 표 아래에 해당 수치가 정량적 관점에서 왜 매력적인지 분석 내용을 덧붙여줘.

        3. **산업 테마 및 최신 동향 분석**:
           - 선정된 종목들이 속한 산업군의 최근 트렌드와 주요 이슈를 설명하고, 해당 종목이 그 흐름에서 어떤 수혜를 입을 수 있는지 너의 지식을 바탕으로 분석해줘.

        4. **시장 전망 및 투자 전략**:
           - 현재 데이터와 시장 흐름에서 보이는 특징, 그리고 투자 시 주의해야 할 리스크 요인을 전문가의 시각에서 조언해줘.

        **작성 가이드라인:**
        - 답변은 한국어로, 신뢰감 있고 전문적인 어조로 작성해줘.
        - 마크다운(Markdown) 형식을 사용하되, 특히 **수치 분석 부분은 가독성을 위해 반드시 표(Table)를 사용**해줘.
        - 리포트 전체에서 종목코드는 절대 표시하지 마.
        """
        
        response = model.generate_content(prompt)
        return response.text

    except Exception as e:
        return f"AI 분석 중 오류가 발생했습니다: {str(e)}"
